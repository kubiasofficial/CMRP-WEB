<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMRP | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #bc13fe; --secondary: #00f2ff; --error: #ff2222; --success: #22ff22; }
        
        body, html { 
            margin: 0; padding: 0; min-height: 100vh; 
            font-family: 'Rajdhani', sans-serif; color: white;
            /* Ujisti se, ≈æe m√°≈° tento obr√°zek ve slo≈æce */
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.7)), 
                        url('pozadicko.jpg') no-repeat center center fixed; 
            background-size: cover;
            display: flex; align-items: center; justify-content: center;
            overflow-x: hidden;
        }

        .dashboard-wrapper {
            width: 100%; display: flex; flex-direction: column;
            align-items: center; padding: 20px; box-sizing: border-box;
        }

        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); z-index: 1000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            backdrop-filter: blur(10px);
        }

        .logo-section { text-align: center; margin-bottom: 40px; }
        #user-avatar { 
            width: 130px; height: 130px; border-radius: 50%; 
            border: 4px solid var(--primary); box-shadow: 0 0 25px var(--primary); 
            margin-bottom: 15px; background: #111;
        }
        #user-name { 
            font-size: 4rem; margin: 0; text-transform: uppercase; 
            letter-spacing: 6px; text-shadow: 0 0 15px var(--primary);
        }

        .card-container { 
            display: flex; gap: 30px; justify-content: center; 
            flex-wrap: wrap; width: 100%; max-width: 1200px;
        }
        .card { 
            background: rgba(10, 10, 10, 0.8); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 20px; padding: 40px 20px; width: 300px; text-align: center;
            transition: 0.3s; cursor: pointer; backdrop-filter: blur(10px); position: relative;
        }
        .card:hover { border-color: var(--primary); transform: translateY(-10px); background: rgba(20, 20, 20, 0.9); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        /* Nov√Ω styl pro Status kartu */
        .status-card { border-bottom: 6px solid #ffcc00; }
        .card-action-text { font-size: 1rem; font-weight: bold; color: var(--secondary); margin-top: 15px; text-transform: uppercase; letter-spacing: 1px; }

        .logout-btn { 
            margin-top: 40px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
            color: white; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-family: 'Rajdhani'; 
            text-transform: uppercase; transition: 0.3s;
        }
        .logout-btn:hover { background: var(--error); border-color: var(--error); }
        .btn-discord { background: #5865F2; color: white; padding: 18px 40px; text-decoration: none; border-radius: 10px; font-weight: bold; font-size: 1.2rem; transition: 0.3s; }
        .btn-discord:hover { background: #4752c4; transform: scale(1.05); }

        /* --- NOV√â STYLY PRO MOD√ÅLN√ç OKNO --- */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; overflow: auto;
            background-color: rgba(0,0,0,0.9); backdrop-filter: blur(15px);
            align-items: center; justify-content: center;
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .modal-content {
            background: rgba(15, 15, 15, 0.95); border: 2px solid var(--primary);
            margin: auto; padding: 40px; border-radius: 25px;
            width: 90%; max-width: 600px; position: relative;
            box-shadow: 0 0 50px rgba(188, 19, 254, 0.3);
            text-align: left;
        }
        .close-modal {
            color: #aaa; float: right; font-size: 2rem; font-weight: bold;
            position: absolute; top: 15px; right: 25px; cursor: pointer; transition: 0.3s;
        }
        .close-modal:hover { color: var(--primary); }

        .modal-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid var(--secondary); padding-bottom: 20px; }
        .modal-header h2 { margin: 0; font-size: 2.5rem; color: var(--secondary); text-transform: uppercase; letter-spacing: 3px; }

        .detail-row { margin-bottom: 25px; }
        .detail-label { display: block; font-size: 0.9rem; color: rgba(255,255,255,0.6); text-transform: uppercase; margin-bottom: 8px; font-weight: bold; letter-spacing: 1px; }
        .detail-value { font-size: 1.3rem; background: rgba(255,255,255,0.05); padding: 15px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); }
        
        .status-pending { color: #ffcc00; }
        .status-success { color: var(--success); }
        .status-error { color: var(--error); }

        .message-box { padding: 20px; border-radius: 10px; background: rgba(255,255,255,0.03); border-left: 5px solid rgba(255,255,255,0.3); }
        .msg-reject { background: rgba(255, 34, 34, 0.1); border-left-color: var(--error); color: #ffbaba; }
        .msg-approve { background: rgba(34, 255, 34, 0.1); border-left-color: var(--success); color: #c7ffc7; }

    </style>
</head>
<body>

    <div id="login-overlay">
        <h1 id="status-heading" style="color:var(--primary); font-size:4rem; margin-bottom:20px;">CMRP</h1>
        <div id="login-actions">
            <a class="btn-discord" href="https://discord.com/oauth2/authorize?client_id=1475163869092511834&response_type=code&redirect_uri=https%3A%2F%2Fcmrp-system.vercel.app%2F&scope=identify+email">P≈òIHL√ÅSIT P≈òES DISCORD</a>
        </div>
        <p id="loading-msg" style="display:none; font-size: 1.5rem; letter-spacing: 2px;">OVƒö≈òOV√ÅN√ç IDENTITY...</p>
    </div>

    <div id="main-ui" class="dashboard-wrapper" style="display:none;">
        <div class="logo-section">
            <img id="user-avatar" src="">
            <h1 id="user-name">HR√Åƒå</h1>
        </div>

        <div class="card-container">
            <div class="card" id="btn-prihlaska" style="border-bottom: 6px solid var(--secondary);">
                <span style="font-size: 3rem;">üìÑ</span>
                <h3>P≈òIHL√Å≈†KA</h3>
                <p>Odeslat ≈æ√°dost o vstup</p>
            </div>

            <div class="card status-card" id="status-card" onclick="openModal()">
                <span style="font-size: 3rem;">üõ°Ô∏è</span>
                <h3>STAV WL</h3>
                <div class="card-action-text">KLIKNI PRO DETAIL PROFILU</div>
            </div>

            <div id="btn-admin" class="card" style="display:none; border-bottom: 6px solid var(--primary);" onclick="location.href='admin.html'">
                <span style="font-size: 3rem;">üëî</span>
                <h3>WL ADDER</h3>
                <p>Administrace</p>
            </div>
        </div>

        <button class="logout-btn" onclick="logout()">ODHL√ÅSIT SE</button>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <div class="modal-header">
                <h2>Detail Profilu</h2>
            </div>
            <div id="modal-body-content">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, getDocs, query, collection, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBpP1B-Gob2GkgQ761nyLTBhCtZBKOCvvs", authDomain: "cmrp-system.firebaseapp.com", projectId: "cmrp-system", storageBucket: "cmrp-system.firebasestorage.app", appId: "1:264321137651:web:295e93bd12e7f8b80fb086" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.logout = () => { localStorage.clear(); window.location.href = window.location.origin; };

        // --- Glob√°ln√≠ promƒõnn√© pro ulo≈æen√≠ dat pro mod√°ln√≠ okno ---
        let currentUserData = null;
        let latestReason = null;
        let currentDiscordId = null;

        // --- Funkce pro Mod√°ln√≠ okno ---
        window.openModal = () => {
            if (!currentUserData) return;
            
            const modal = document.getElementById('profile-modal');
            const content = document.getElementById('modal-body-content');
            
            // 1. Zpracov√°n√≠ statusu pro zobrazen√≠
            let statusDisplay = '<span class="status-pending">≈Ω√°dn√° ≈æ√°dost</span>';
            let messageDisplay = '<div class="message-box">≈Ω√°dn√© nov√© zpr√°vy.</div>';

            if (currentUserData.wlStatus === 'v ≈ôe≈°en√≠') {
                statusDisplay = '<span class="status-pending">ƒåek√° na vyhodnocen√≠</span>';
                messageDisplay = '<div class="message-box" style="border-color:#ffcc00">Tv√° ≈æ√°dost byla odesl√°na a ƒçek√° na kontrolu admin t√Ωmem.</div>';
            } else if (currentUserData.wlStatus === 'schv√°leno') {
                statusDisplay = '<span class="status-success">P≈òIJAT(A)</span>';
                messageDisplay = '<div class="message-box msg-approve">üéâ Gratulujeme! Tv√° ≈æ√°dost byla schv√°lena. V√≠tej na serveru!</div>';
            } else if (currentUserData.wlStatus === 'zam√≠tnuto') {
                statusDisplay = '<span class="status-error">NEP≈òIJAT(A)</span>';
                messageDisplay = `<div class="message-box msg-reject"><strong>D≈ÆVOD ZAM√çTNUT√ç:</strong><br>${latestReason || "D≈Øvod neuveden."}</div>`;
            }

            // 2. Vlo≈æen√≠ HTML do mod√°ln√≠ho okna
            content.innerHTML = `
                <div class="detail-row">
                    <span class="detail-label">Discord ID</span>
                    <div class="detail-value" style="font-family: monospace;">${currentDiscordId}</div>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Zb√Ωvaj√≠c√≠ pokusy</span>
                    <div class="detail-value">${currentUserData.attempts ?? 3} / 3</div>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Stav posledn√≠ ≈æ√°dosti</span>
                    <div class="detail-value">${statusDisplay}</div>
                </div>
                <div class="detail-row" style="margin-top: 30px;">
                    <span class="detail-label">P≈ô√≠choz√≠ zpr√°vy</span>
                    ${messageDisplay}
                </div>
            `;

            modal.style.display = "flex";
        };

        window.closeModal = () => {
            document.getElementById('profile-modal').style.display = "none";
        };

        // Kliknut√≠ mimo okno ho zav≈ôe
        window.onclick = (event) => {
            const modal = document.getElementById('profile-modal');
            if (event.target == modal) closeModal();
        }


        // --- Hlavn√≠ logika p≈ôihl√°≈°en√≠ a naƒç√≠t√°n√≠ dat ---
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
            document.getElementById('login-actions').style.display = 'none';
            document.getElementById('loading-msg').style.display = 'block';
            fetch(`/api/auth?code=${code}`).then(res => res.json()).then(data => {
                localStorage.setItem('discord_user', JSON.stringify({discordId: data.id, username: data.username, avatar: `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.png`}));
                window.location.href = window.location.origin;
            }).catch(err => { console.error(err); alert("Chyba p≈ôihl√°≈°en√≠."); window.location.href = window.location.origin; });
        }

        const savedUser = localStorage.getItem('discord_user');
        if (savedUser) {
            const user = JSON.parse(savedUser);
            currentDiscordId = user.discordId; // Ulo≈æen√≠ ID pro modal
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
            document.getElementById('user-name').innerText = user.username;
            document.getElementById('user-avatar').src = user.avatar;

            // Real-time sledov√°n√≠ dat
            onSnapshot(doc(db, "users", user.discordId), async (ds) => {
                if (ds.exists()) {
                    currentUserData = ds.data(); // Ulo≈æen√≠ dat pro modal
                    const status = currentUserData.wlStatus || "none";
                    const att = currentUserData.attempts ?? 3;
                    
                    // Aktualizace barvy karty (text u≈æ na n√≠ nen√≠)
                    const sCard = document.getElementById('status-card');
                    if(status === "schv√°leno") sCard.style.borderColor = "var(--success)";
                    else if(status === "zam√≠tnuto") sCard.style.borderColor = "var(--error)";
                    else sCard.style.borderColor = "#ffcc00";

                    // Zobrazen√≠ Admin tlaƒç√≠tka
                    if(currentUserData.role === "admin") document.getElementById('btn-admin').style.display = "block";

                    // Logika tlaƒç√≠tka P≈ôihl√°≈°ka
                    document.getElementById('btn-prihlaska').onclick = () => {
                        if(status === "v ≈ôe≈°en√≠") return alert("Tv√° ≈æ√°dost se ji≈æ zpracov√°v√°.");
                        if(status === "schv√°leno") return alert("Ji≈æ jsi ƒçlenem WhiteListu.");
                        if(att <= 0) return alert("Bohu≈æel ji≈æ nem√°≈° ≈æ√°dn√© pokusy.");
                        location.href = 'prihlaska.html';
                    };

                    // Naƒçten√≠ d≈Øvodu, pokud je zam√≠tnuto (pro modal)
                    if(status === "zam√≠tnuto") {
                        const h = await getDocs(query(collection(db, "history"), where("playerID", "==", user.discordId), orderBy("date", "desc"), limit(1)));
                        if(!h.empty) latestReason = h.docs[0].data().reason;
                    } else {
                        latestReason = null;
                    }
                }
            });
        }
    </script>
</body>
</html>