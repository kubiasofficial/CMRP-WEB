<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CMRP | Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #bc13fe; --secondary: #00f2ff; --error: #ff2222; --success: #22ff22; }
        
        body, html { 
            margin: 0; padding: 0; min-height: 100vh; 
            font-family: 'Rajdhani', sans-serif; color: white;
            background: linear-gradient(rgba(0,0,0,0.4), rgba(0,0,0,0.7)), 
                        url('pozadicko.jpg') no-repeat center center fixed; 
            background-size: cover;
            display: flex; align-items: center; justify-content: center;
            overflow-x: hidden;
        }

        /* --- LOGO STYLY --- */
        .corner-logo {
            position: absolute;
            top: 25px;
            left: 25px;
            width: 80px;
            height: auto;
            filter: drop-shadow(0 0 10px var(--primary));
            z-index: 10;
        }

        .login-logo {
            width: 180px;
            margin-bottom: 20px;
            filter: drop-shadow(0 0 20px var(--primary));
        }

        #login-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.9); z-index: 1000; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            backdrop-filter: blur(15px);
        }

        .dashboard-wrapper {
            width: 100%; display: flex; flex-direction: column;
            align-items: center; padding: 20px; box-sizing: border-box;
            position: relative;
        }

        .logo-section { text-align: center; margin-bottom: 40px; margin-top: 40px; }
        #user-avatar { 
            width: 130px; height: 130px; border-radius: 50%; 
            border: 4px solid var(--primary); box-shadow: 0 0 25px var(--primary); 
            margin-bottom: 15px; background: #111;
        }
        #user-name { 
            font-size: 4rem; margin: 0; text-transform: uppercase; 
            letter-spacing: 6px; text-shadow: 0 0 15px var(--primary);
        }

        .card-container { 
            display: flex; gap: 30px; justify-content: center; 
            flex-wrap: wrap; width: 100%; max-width: 1200px;
        }
        .card { 
            background: rgba(10, 10, 10, 0.8); border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 20px; padding: 40px 20px; width: 300px; text-align: center;
            transition: 0.3s; cursor: pointer; backdrop-filter: blur(10px);
        }
        .card:hover { border-color: var(--primary); transform: translateY(-10px); background: rgba(20, 20, 20, 0.9); }
        
        .status-card { border-bottom: 6px solid #ffcc00; }
        .card-action-text { font-size: 1rem; font-weight: bold; color: var(--secondary); margin-top: 15px; text-transform: uppercase; }

        .logout-btn { 
            margin-top: 40px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
            color: white; padding: 12px 30px; border-radius: 8px; cursor: pointer; font-family: 'Rajdhani'; 
            text-transform: uppercase; transition: 0.3s;
        }
        .logout-btn:hover { background: var(--error); }

        .btn-discord { background: #5865F2; color: white; padding: 18px 40px; text-decoration: none; border-radius: 10px; font-weight: bold; font-size: 1.2rem; transition: 0.3s; }
        .btn-discord:hover { transform: scale(1.05); box-shadow: 0 0 20px #5865F2; }

        /* MODAL */
        .modal {
            display: none; position: fixed; z-index: 2000; left: 0; top: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.95); backdrop-filter: blur(15px);
            align-items: center; justify-content: center;
        }
        .modal-content {
            background: rgba(15, 15, 15, 0.95); border: 2px solid var(--primary);
            padding: 40px; border-radius: 25px; width: 90%; max-width: 600px; position: relative;
        }
        .close-modal { position: absolute; top: 15px; right: 25px; font-size: 2rem; cursor: pointer; color: #aaa; }
        .detail-row { margin-bottom: 20px; text-align: left; }
        .detail-value { background: rgba(255,255,255,0.05); padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); font-size: 1.1rem; }
        .message-box { padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 4px solid var(--primary); background: rgba(255,255,255,0.02); }
    </style>
</head>
<body>

    <div id="login-overlay">
        <img src="cmrp.png" alt="Logo" class="login-logo">
        <h1 style="color:white; font-size:3.5rem; margin: 0 0 30px 0; letter-spacing: 8px;">CMRP</h1>
        <div id="login-actions">
            <a class="btn-discord" href="https://discord.com/oauth2/authorize?client_id=1475163869092511834&response_type=code&redirect_uri=https%3A%2F%2Fcmrp-system.vercel.app%2F&scope=identify+email">P≈òIHL√ÅSIT P≈òES DISCORD</a>
        </div>
        <p id="loading-msg" style="display:none;">OVƒö≈òOV√ÅN√ç IDENTITY...</p>
    </div>

    <div id="main-ui" class="dashboard-wrapper" style="display:none;">
        <img src="cmrp.png" alt="Logo" class="corner-logo">
        
        <div class="logo-section">
            <img id="user-avatar" src="">
            <h1 id="user-name">HR√Åƒå</h1>
        </div>

        <div class="card-container">
            <div class="card" id="btn-prihlaska" style="border-bottom: 6px solid var(--secondary);">
                <span style="font-size: 3rem;">üìÑ</span>
                <h3>P≈òIHL√Å≈†KA</h3>
                <p>Odeslat ≈æ√°dost o vstup</p>
            </div>

            <div class="card status-card" id="status-card" onclick="openModal()">
                <span style="font-size: 3rem;">üõ°Ô∏è</span>
                <h3>STAV WL</h3>
                <div class="card-action-text">KLIKNI PRO DETAIL PROFILU</div>
            </div>

            <div id="btn-admin" class="card" style="display:none; border-bottom: 6px solid var(--primary);" onclick="location.href='admin.html'">
                <span style="font-size: 3rem;">üëî</span>
                <h3>WL ADDER</h3>
                <p>Administrace</p>
            </div>
        </div>

        <button class="logout-btn" onclick="logout()">ODHL√ÅSIT SE</button>
    </div>

    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeModal()">&times;</span>
            <h2 style="text-align:center; color:var(--secondary); text-transform:uppercase;">Detail Profilu</h2>
            <div id="modal-body-content"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, doc, onSnapshot, getDocs, query, collection, where, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyBpP1B-Gob2GkgQ761nyLTBhCtZBKOCvvs", authDomain: "cmrp-system.firebaseapp.com", projectId: "cmrp-system", storageBucket: "cmrp-system.firebasestorage.app", appId: "1:264321137651:web:295e93bd12e7f8b80fb086" };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.logout = () => { localStorage.clear(); window.location.href = window.location.origin; };

        let currentUserData = null;
        let latestReason = null;
        let currentDiscordId = null;

        window.openModal = () => {
            if (!currentUserData) return;
            const content = document.getElementById('modal-body-content');
            let statusHTML = currentUserData.wlStatus === 'v ≈ôe≈°en√≠' ? '<span style="color:#ffcc00">ƒåek√° na vyhodnocen√≠</span>' : 
                             currentUserData.wlStatus === 'schv√°leno' ? '<span style="color:#22ff22">P≈òIJAT(A)</span>' : 
                             currentUserData.wlStatus === 'zam√≠tnuto' ? '<span style="color:#ff2222">NEP≈òIJAT(A)</span>' : '≈Ω√°dn√° ≈æ√°dost';

            content.innerHTML = `
                <div class="detail-row"><label>Discord ID</label><div class="detail-value">${currentDiscordId}</div></div>
                <div class="detail-row"><label>Zb√Ωvaj√≠c√≠ pokusy</label><div class="detail-value">${currentUserData.attempts ?? 3} / 3</div></div>
                <div class="detail-row"><label>Stav posledn√≠ ≈æ√°dosti</label><div class="detail-value">${statusHTML}</div></div>
                <div class="detail-row"><label>Zpr√°vy</label><div class="message-box">${latestReason ? "D≈Øvod zam√≠tnut√≠: " + latestReason : "≈Ω√°dn√© nov√© zpr√°vy."}</div></div>
            `;
            document.getElementById('profile-modal').style.display = "flex";
        };

        window.closeModal = () => document.getElementById('profile-modal').style.display = "none";

        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get('code');

        if (code) {
            document.getElementById('login-actions').style.display = 'none';
            document.getElementById('loading-msg').style.display = 'block';
            fetch(`/api/auth?code=${code}`).then(res => res.json()).then(data => {
                localStorage.setItem('discord_user', JSON.stringify({discordId: data.id, username: data.username, avatar: `https://cdn.discordapp.com/avatars/${data.id}/${data.avatar}.png`}));
                window.location.href = window.location.origin;
            });
        }

        const savedUser = localStorage.getItem('discord_user');
        if (savedUser) {
            const user = JSON.parse(savedUser);
            currentDiscordId = user.discordId;
            document.getElementById('login-overlay').style.display = 'none';
            document.getElementById('main-ui').style.display = 'flex';
            document.getElementById('user-name').innerText = user.username;
            document.getElementById('user-avatar').src = user.avatar;

            onSnapshot(doc(db, "users", user.discordId), async (ds) => {
                if (ds.exists()) {
                    currentUserData = ds.data();
                    if(currentUserData.role === "admin") document.getElementById('btn-admin').style.display = "block";
                    if(currentUserData.wlStatus === "zam√≠tnuto") {
                        const h = await getDocs(query(collection(db, "history"), where("playerID", "==", user.discordId), orderBy("date", "desc"), limit(1)));
                        if(!h.empty) latestReason = h.docs[0].data().reason;
                    }
                }
            });

            document.getElementById('btn-prihlaska').onclick = () => {
                if(currentUserData?.wlStatus === "v ≈ôe≈°en√≠") return alert("Tv√° ≈æ√°dost se ji≈æ zpracov√°v√°.");
                location.href = 'prihlaska.html';
            };
        }
    </script>
</body>
</html>