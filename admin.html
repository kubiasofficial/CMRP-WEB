<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <title>CMRP | Admin Panel</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #bc13fe; --secondary: #00f2ff; }
        body { margin: 0; padding: 0; font-family: 'Rajdhani', sans-serif; background: #050505; color: white; height: 100vh; overflow: hidden; }
        .admin-layout { display: grid; grid-template-columns: 320px 1fr 300px; gap: 15px; padding: 15px; height: 100vh; box-sizing: border-box; }
        .col { background: rgba(15,15,15,0.9); border: 1px solid #222; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .col-header { padding: 15px; background: rgba(188,19,254,0.1); border-bottom: 1px solid var(--primary); text-align: center; font-weight: bold; letter-spacing: 2px; color: var(--primary); }
        .col-content { flex: 1; overflow-y: auto; padding: 15px; }
        
        /* Karty */
        .card { background: #111; border: 1px solid #333; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .hist-item { font-size: 0.85rem; border-left: 3px solid #444; padding-left: 10px; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #222; }
        .hist-schv√°leno { border-left-color: #22ff22; }
        .hist-zam√≠tnuto { border-left-color: #ff2222; }
        
        .q-box { background: rgba(255,255,255,0.03); padding: 10px; border-radius: 5px; margin: 10px 0; font-size: 0.9rem; border-left: 2px solid var(--secondary); }
        input[type="text"] { width: 100%; background: #000; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; margin-bottom: 10px; font-family: 'Rajdhani'; }
        button { padding: 8px 15px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-family: 'Rajdhani'; }
        
        .adder-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #222; }
        .adder-item img { width: 30px; border-radius: 50%; border: 1px solid var(--primary); }
    </style>
</head>
<body>
    <div class="admin-layout">
        <div class="col">
            <div class="col-header">üìú HISTORIE</div>
            <div class="col-content" id="hist-list"></div>
        </div>

        <div class="col">
            <div class="col-header">üì• P≈ò√çCHOZ√ç ≈Ω√ÅDOSTI</div>
            <div class="col-content" id="req-list"></div>
        </div>

        <div class="col">
            <div class="col-header">üõ°Ô∏è WL ADDE≈òI</div>
            <div class="col-content" id="adder-list"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, deleteDoc, updateDoc, addDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        const firebaseConfig = { apiKey: "AIzaSyBpP1B-Gob2GkgQ761nyLTBhCtZBKOCvvs", authDomain: "cmrp-system.firebaseapp.com", projectId: "cmrp-system", storageBucket: "cmrp-system.firebasestorage.app", appId: "1:264321137651:web:295e93bd12e7f8b80fb086" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);

        // 1. NAƒå√çT√ÅN√ç HISTORIE
        onSnapshot(query(collection(db, "history"), orderBy("date", "desc")), (snap) => {
            const list = document.getElementById('hist-list'); list.innerHTML = "";
            snap.forEach(s => {
                const d = s.data();
                list.innerHTML += `<div class="hist-item hist-${d.status}">
                    <strong>${d.status.toUpperCase()}</strong>: ${d.targetNick || d.uid}<br>
                    <small>Admin: ${d.admin} | Pokus: ${d.pokus || '?'}</small>
                </div>`;
            });
        });

        // 2. NAƒå√çT√ÅN√ç ≈Ω√ÅDOST√ç (S MO≈ΩNOST√ç ƒåTEN√ç)
        onSnapshot(collection(db, "zadosti"), (snap) => {
            const list = document.getElementById('req-list'); list.innerHTML = snap.empty ? "≈Ω√°dn√© ≈æ√°dosti k vy≈ô√≠zen√≠." : "";
            snap.forEach(s => {
                const d = s.data();
                const card = document.createElement('div'); card.className = "card";
                card.innerHTML = `
                    <div style="display:flex; align-items:center; gap:10px; margin-bottom:10px;">
                        <img src="${d.avatar}" style="width:40px; border-radius:50%;">
                        <strong>${d.discordTag}</strong> <span style="color:var(--secondary)">(Pokus: ${d.pokus}.)</span>
                    </div>
                    <div class="q-box"><strong>LORE:</strong> ${d.lore}</div>
                    <div class="q-box"><strong>FEAR/META/EMS:</strong><br>${d.fear}<br>---<br>${d.meta}<br>---<br>${d.ems}</div>
                    <input type="text" id="reason-${s.id}" placeholder="D≈Øvod zam√≠tnut√≠ / Pozn√°mka...">
                    <div style="display:flex; gap:10px;">
                        <button style="background:#22ff22; flex:1;" onclick="decide('${s.id}', '${d.discordId}', 'schv√°leno', ${JSON.stringify(d).replace(/"/g, '&quot;')})">SCHV√ÅLIT</button>
                        <button style="background:#ff2222; color:white; flex:1;" onclick="decide('${s.id}', '${d.discordId}', 'zam√≠tnuto', ${JSON.stringify(d).replace(/"/g, '&quot;')})">ZAM√çTNOUT</button>
                    </div>`;
                list.appendChild(card);
            });
        });

        // 3. SEZNAM WL ADDER≈Æ (U≈æivatel√© s rol√≠ admin)
        onSnapshot(query(collection(db, "users"), where("role", "==", "admin")), (snap) => {
            const list = document.getElementById('adder-list'); list.innerHTML = "";
            snap.forEach(s => {
                const d = s.data();
                list.innerHTML += `<div class="adder-item"><img src="https://cdn.discordapp.com/embed/avatars/0.png"> <span>${d.username}</span></div>`;
            });
        });

        window.decide = async (docId, uid, status, originalData) => {
            const reason = document.getElementById(`reason-${docId}`).value;
            const admin = JSON.parse(localStorage.getItem('user'))?.username || "Nezn√°m√Ω Admin";
            if (status === 'zam√≠tnuto' && !reason) return alert("Zadej d≈Øvod zam√≠tnut√≠!");

            await updateDoc(doc(db, "users", uid), { wlStatus: status });
            await addDoc(collection(db, "history"), { uid, targetNick: originalData.discordTag, status, reason: reason || "Schv√°leno", admin: admin, pokus: originalData.pokus, date: serverTimestamp() });
            await deleteDoc(doc(db, "zadosti", docId));

            // WEBHOOKY
            const webhook = status === 'schv√°leno' ? "https://discord.com/api/webhooks/1476489493056979004/Q2y0Kl0wpzyanQJWPd3OKuP_ZKw9lkjSQOohONKhAZpqb4XzCEh3TNOM-avN7bFCLaBP" : "https://discord.com/api/webhooks/1476489397254885438/wsZXiU-fudd36_hDir8aSFNSdKUeJZYADJoVJMS99E0m1w2CbioG0KZHRlpdBF7krMkg";
            await fetch(webhook, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify({ embeds: [{
                title: status === 'schv√°leno' ? "‚úÖ ≈Ω√°dost Schv√°lena" : "‚ùå ≈Ω√°dost Zam√≠tnuta", color: status==='schv√°leno'?3066993:15158332, thumbnail: {url: originalData.avatar},
                fields: [{name:"Hr√°ƒç", value:originalData.discordTag, inline:true},{name:"Pokus", value:originalData.pokus+".", inline:true},{name:"WL Adder", value:admin, inline:true},{name:"D≈Øvod/Pozn√°mka", value:reason || "Schv√°leno"}], timestamp: new Date()
            }]})});
            alert("Vy≈ô√≠zeno!");
        };
    </script>
</body>
</html>